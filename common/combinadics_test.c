// gcc combinadics.c -lgmp

#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>

#include "api.h"
#include "fq_arithmetic/vf3.h"
#include "gmp.h"
#include "params.h"
#include "util/bitstream.h"
#include "util/compress.h"

int main(int argc, char **argv) {
  // Indices of 0-entries to compress:
  uint32_t idx[N - WEIGHT] = {
      7,    12,   13,   14,   22,   27,   32,   42,   55,   56,   58,   60,
      64,   67,   68,   70,   73,   76,   82,   87,   90,   97,   105,  107,
      108,  116,  117,  126,  131,  135,  138,  144,  149,  150,  158,  164,
      168,  172,  184,  188,  206,  210,  212,  213,  222,  228,  229,  234,
      235,  239,  243,  251,  259,  262,  264,  265,  267,  281,  287,  295,
      301,  302,  304,  306,  309,  319,  326,  337,  345,  348,  350,  354,
      357,  372,  382,  384,  386,  388,  392,  401,  415,  416,  424,  429,
      441,  447,  466,  468,  470,  471,  472,  481,  496,  497,  498,  503,
      506,  510,  515,  518,  522,  527,  533,  535,  536,  540,  543,  544,
      551,  554,  555,  556,  560,  567,  570,  571,  580,  588,  590,  594,
      595,  611,  615,  621,  628,  636,  639,  641,  646,  657,  666,  672,
      675,  680,  683,  687,  688,  703,  731,  732,  738,  743,  744,  748,
      749,  765,  771,  775,  784,  785,  790,  795,  797,  798,  801,  806,
      817,  820,  827,  831,  839,  843,  849,  859,  861,  864,  874,  876,
      887,  889,  896,  897,  902,  904,  905,  906,  913,  916,  917,  919,
      923,  925,  926,  928,  938,  942,  944,  947,  954,  962,  977,  981,
      1005, 1013, 1021, 1031, 1036, 1042, 1043, 1061, 1062, 1063, 1064, 1068,
      1074, 1076, 1084, 1088, 1099, 1104, 1111, 1114, 1119, 1123, 1125, 1127,
      1129, 1137, 1141, 1144, 1151, 1153, 1173, 1174, 1175, 1183, 1195, 1206,
      1211, 1213, 1218, 1221, 1225, 1230, 1239, 1241, 1247, 1249, 1255, 1259,
      1260, 1264, 1266, 1270, 1274, 1284, 1291, 1292, 1301, 1313, 1315, 1316,
      1326, 1329, 1330, 1331, 1332, 1335, 1337, 1338, 1341, 1350, 1353, 1354,
      1359, 1361, 1363, 1365, 1366, 1369, 1383, 1385, 1390, 1395, 1396, 1401,
      1404, 1413, 1420, 1423, 1429, 1432, 1435, 1438, 1449, 1451, 1452, 1467,
      1478, 1488, 1489, 1491, 1493, 1496, 1498, 1499, 1503, 1517, 1520, 1523,
      1531, 1534, 1537, 1539, 1543, 1544, 1551, 1556, 1566, 1569, 1578, 1581,
      1584, 1587, 1594, 1595, 1602, 1613, 1617, 1623, 1624, 1628, 1635, 1636,
      1637, 1640, 1651, 1654, 1655, 1656, 1657, 1658, 1663, 1665, 1674, 1680,
      1685, 1686, 1693, 1701, 1703, 1704, 1707, 1710, 1719, 1720, 1721, 1722,
      1729, 1731, 1732, 1738, 1739, 1740, 1746, 1753, 1763, 1770, 1771, 1782,
      1783, 1784, 1788, 1792, 1795, 1798, 1807, 1808, 1812, 1815, 1817, 1821,
      1822, 1826, 1827, 1829, 1843, 1846, 1847, 1848, 1850, 1856, 1858, 1871,
      1872, 1874, 1875, 1887, 1888, 1891, 1907, 1910, 1917, 1922, 1935, 1937,
      1940, 1943, 1953, 1954, 1960, 1962, 1965, 1980, 1982, 1984, 1987, 1988,
      1989, 1992, 2003, 2010, 2015, 2030, 2034, 2037, 2039, 2046, 2048, 2049,
      2050, 2055, 2057, 2062, 2080, 2082, 2086, 2096, 2103, 2107, 2114, 2120,
      2123, 2125, 2127, 2128, 2129, 2135, 2139, 2142, 2148, 2152, 2155, 2165,
      2171, 2173, 2176, 2179, 2189, 2205, 2210, 2211, 2216, 2228, 2234, 2235,
      2236, 2244, 2245, 2248, 2253, 2254, 2262, 2269, 2273, 2275, 2282, 2288,
      2289, 2297, 2299, 2302, 2303, 2313, 2314, 2324, 2326, 2327, 2329, 2330,
      2332, 2340, 2345, 2350, 2352, 2353, 2363, 2373, 2376, 2387, 2391, 2394,
      2410, 2411, 2412, 2418, 2421, 2428, 2429, 2435, 2445, 2448, 2452, 2454,
      2455, 2457, 2462, 2471, 2481, 2484, 2486, 2489, 2490, 2496, 2507, 2516,
      2526, 2545, 2546, 2549, 2551, 2552, 2553, 2558, 2559, 2561, 2575, 2579,
      2584, 2588, 2597, 2600, 2601, 2602, 2607, 2612, 2614, 2619, 2621, 2629,
      2636, 2638, 2639, 2648, 2650, 2652, 2653, 2654, 2657, 2660, 2663, 2664,
      2665, 2669, 2680, 2684, 2687, 2691, 2702, 2705, 2707, 2719, 2722, 2728,
      2731, 2732, 2733, 2736, 2740, 2743, 2749, 2751, 2760, 2763, 2765, 2767,
      2772, 2773, 2781, 2785, 2788, 2790, 2793, 2794, 2799, 2806, 2807, 2808,
      2810, 2813, 2814, 2819, 2821, 2835, 2842, 2843, 2853, 2857, 2858, 2860,
      2869, 2871, 2872, 2875, 2888, 2903, 2909, 2915, 2919, 2930, 2933, 2936,
      2938, 2945, 2962, 2967, 2969, 2975, 2978, 2980, 2989, 2990, 2991, 2995,
      2996, 3001, 3007, 3008, 3009, 3011, 3012, 3015, 3020, 3022, 3026, 3028,
      3029, 3032, 3036, 3042, 3043, 3044, 3045, 3048, 3051, 3060, 3062, 3066,
      3068, 3073, 3078, 3084, 3094, 3096, 3097, 3102, 3104, 3105, 3113, 3115,
      3120, 3121, 3124, 3125, 3135, 3145, 3146, 3147, 3148, 3151, 3160, 3174,
      3181, 3182, 3185, 3186, 3189, 3195, 3199, 3202, 3206, 3207, 3208, 3209,
      3218, 3227, 3235, 3236, 3237, 3242, 3246, 3251, 3252, 3263, 3266, 3269,
      3276, 3286, 3295, 3296, 3304, 3308, 3310, 3312, 3320, 3321, 3326, 3331,
      3333, 3335, 3343, 3353, 3359, 3367, 3375, 3376, 3379, 3380, 3388, 3391,
      3395, 3399, 3402, 3409, 3410, 3411, 3416, 3428, 3440, 3447, 3453, 3455,
      3456, 3459, 3461, 3463, 3465, 3476, 3480, 3487, 3488, 3492, 3494, 3496,
      3511, 3513, 3517, 3524, 3525, 3533, 3534, 3554, 3557, 3561, 3562, 3566,
      3579, 3580, 3587, 3593, 3594, 3603, 3607, 3608, 3611, 3617, 3618, 3632,
      3635, 3642, 3647, 3650, 3657, 3661, 3663, 3668, 3669, 3672, 3679, 3689,
      3696, 3702, 3703, 3706, 3712, 3722, 3726, 3729, 3730, 3732, 3733, 3738,
      3746, 3747, 3751, 3763, 3765, 3767, 3773, 3777, 3780, 3782, 3800, 3804,
      3805, 3808, 3818, 3820, 3827, 3831, 3843, 3850, 3852, 3853, 3859, 3874,
      3876, 3877, 3881, 3888, 3890, 3892, 3902, 3907, 3911, 3920, 3933, 3934,
      3943, 3950, 3953, 3955, 3966, 3968, 3971, 3976, 3987, 3990, 3991, 3994,
      3995, 3998, 4003, 4007, 4010, 4013, 4014, 4016, 4018, 4019, 4021, 4035,
      4041, 4048, 4054, 4062, 4064, 4065, 4076, 4080, 4082, 4096, 4098, 4099,
      4103, 4104, 4112, 4114, 4115, 4118, 4119, 4128, 4130, 4131, 4133, 4137,
      4140, 4141, 4147, 4148, 4161, 4170, 4171, 4174, 4178, 4183, 4189, 4192,
      4193, 4202, 4208, 4214, 4221, 4227, 4232, 4234, 4240, 4250, 4251, 4252,
      4255, 4260, 4264, 4267, 4271, 4273, 4277, 4286};

  vf3_e *sig = vf3_alloc(K);

  vf3_random_non_zero(sig);

  for (int i = 0; i < (N - WEIGHT) >> 1; i++) vf3_set_coeff(idx[i], sig, 0);

  uint8_t buf[CRYPTO_BYTES] = {0};

  printf("CRYPTO_BYTES: %i\n", CRYPTO_BYTES);
  printf("BIN_K_WEIGHT_N_BYTES: %i\n", BIN_K_WEIGHT_N_BYTES);  // CRYPTO_BYTES);

  bitstream_t bs;
  bs_init(&bs, buf, CRYPTO_BYTES);

  compress(&bs, sig);

  printf("sig size: %i\n", bs.byte_pos + (bs.bit_pos > 0 ? 1 : 0));

  bs_init(&bs, buf, CRYPTO_BYTES);

  vf3_e *sig2 = vf3_alloc(K);

  decompress(&bs, sig2);

  for (int i = 0; i < K; i++)
    if (vf3_get_element(i, sig) != vf3_get_element(i, sig2)) {
      printf("err!  %i - %i vs. %i\n", i, vf3_get_element(i, sig),
             vf3_get_element(i, sig2));
      exit(-1);
    }

  printf("ok!\n");

  return EXIT_SUCCESS;
}
